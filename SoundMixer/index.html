<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>SoundMixer</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- PixiJS + Live2D Display (Cubism 4 지원) -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display-lipsyncpatch/dist/cubism4.min.js"></script>
</head>

<body>

    <section id="scene-title" class="scene active">
        <div class="logo-area">
            <h1>SOUND<br>MIXER</h1>
            <p>PRESS ENTER TO START</p>
        </div>
        <!-- Unity-chan License -->
        <div class="unitychan-license">
            <img src="assets/unitychan_Licence/License/License Logo/Unitychan_License2.png" alt="Unity-chan License Logo" class="license-logo">
            <div class="license-text">
                <div class="license-copyright">© Unity Technologies Japan/UCL</div>
                <div class="license-description">
                    This game uses <a href="https://unity-chan.com/" target="_blank">Unity-chan</a> model<br>
                    licensed under <a href="https://unity-chan.com/contents/guideline/" target="_blank">Unity-chan License</a>
                </div>
            </div>
        </div>
    </section>

    <!-- [Phase 2] 로딩 화면 (타이틀 → 선곡 사이) -->
    <section id="scene-loading" class="scene" style="z-index: 99999;">
        <div class="loading-container">
            <h2 class="loading-title">LOADING</h2>
            <div class="loading-bar-container">
                <div id="loading-bar" class="loading-bar"></div>
            </div>
            <p id="loading-text" class="loading-text">Initializing...</p>
        </div>
    </section>

    <section id="scene-select" class="scene">
        <div class="select-header">
            <span>SELECT MUSIC</span>
            <div class="user-info-area" style="display:flex; align-items:center;">
                <span style="color:#888; margin-right:10px;">PLAYER:</span>
                <span id="display-name" style="color:#00d2ff; font-weight:bold; font-size:20px;">GUEST</span>
                <input type="text" id="input-name"
                    style="display:none; width:150px; background:#222; border:1px solid #555; color:#fff; padding:5px;">
                <button id="btn-change-name"
                    style="margin-left:10px; background:#333; border:1px solid #555; color:#fff; cursor:pointer; padding:5px 10px;">EDIT</button>
            </div>
        </div>

        <div class="select-content-wrapper">
            <!-- [신규] 비디오 프리뷰 -->
            <div id="select-preview-container" class="select-preview-container">
                <video id="select-preview-video" muted loop playsinline></video>
                <div id="select-preview-overlay" class="select-preview-overlay"></div>
            </div>

            <div class="ranking-board">
                <h2 class="rank-header">TOP RANKING</h2>
                <div id="ranking-list" style="flex:1; color: #fff; font-family: monospace;">
                    <div>Loading...</div>
                </div>
                <div style="border-top: 2px solid #555; padding-top: 15px; margin-top: 10px;">
                    <h3 style="color:#aaa; font-size:14px; margin-bottom:10px;">MY RECORD</h3>
                    <div id="my-rank-info" style="font-family: monospace; color:#fff;">
                        <div style="color:#555">No Record</div>
                    </div>
                </div>
            </div>

            <div class="song-list-container">
                <div class="song-list" id="song-container"></div>
            </div>
        </div>

        <div class="option-panel">
            <div class="quick-info">
                <span id="disp-speed">2.0</span> <span style="color:#555">/</span>
                <span id="disp-level">LV.5</span> <span style="color:#555">·</span>
                <span id="disp-diff">NORMAL</span>
            </div>
            <div class="start-msg">PRESS ENTER TO PLAY</div>
            <div class="open-opt-hint">
                PRESS <span style="color:#00d2ff; font-weight:bold;">[O]</span> FOR OPTIONS
            </div>
        </div>

        <div id="side-options" class="side-panel">
            <div class="panel-header">
                <h2>GAME OPTIONS</h2>
                <button id="btn-close-opt">✕</button>
            </div>

            <div class="panel-content">
                <div class="opt-section">
                    <h3>GAMEPLAY</h3>

                    <div class="opt-row" id="row-speed">
                        <label>SPEED (Q/E)</label>
                        <div class="control">
                            <button id="btn-speed-down">◀</button>
                            <span id="val-speed">2.0</span>
                            <button id="btn-speed-up">▶</button>
                        </div>
                    </div>

                    <div class="opt-row" id="row-diff">
                        <label>DIFFICULTY</label>
                        <div class="control">
                            <button id="btn-diff-prev">◀</button>
                            <span id="val-diff" style="font-size:14px;">NORMAL</span>
                            <button id="btn-diff-next">▶</button>
                        </div>
                    </div>

                    <div class="opt-row" id="row-key-config">
                        <label>KEY CONFIG</label>
                        <button id="btn-key-config" style="width:auto; padding:5px 10px; font-size:12px;">4
                            KEYS</button>
                    </div>
                </div>

                <div class="opt-section">
                    <h3>DISPLAY</h3>
                    <div class="opt-row" id="row-dim">
                        <label>BGA DIM</label>
                        <div class="control"><button id="btn-dim-down">◀</button><span id="val-dim">50%</span><button
                                id="btn-dim-up">▶</button></div>
                    </div>
                    <div class="opt-row" id="row-skin">
                        <label>NOTE SKIN</label>
                        <div class="control"><button id="btn-skin-prev">◀</button><span id="val-skin"
                                style="font-size:12px;">Default</span><button id="btn-skin-next">▶</button></div>
                    </div>
                </div>

                <div class="opt-section">
                    <h3>AUDIO</h3>
                    <div class="opt-row" id="row-music">
                        <label>MUSIC VOL</label>
                        <div class="control"><button id="btn-music-down">◀</button><span
                                id="val-music">100%</span><button id="btn-music-up">▶</button></div>
                    </div>
                    <div class="opt-row" id="row-sfx">
                        <label>SFX VOL</label>
                        <div class="control"><button id="btn-sfx-down">◀</button><span id="val-sfx">100%</span><button
                                id="btn-sfx-up">▶</button></div>
                    </div>
                    <div class="opt-row" id="row-voice">
                        <label>VOICE VOL</label>
                        <div class="control"><button id="btn-voice-down">◀</button><span
                                id="val-voice">100%</span><button id="btn-voice-up">▶</button></div>
                    </div>
                    <div class="opt-row" id="row-offset">
                        <label>OFFSET</label>
                        <div class="control"><button id="btn-offset-down">◀</button><span
                                id="val-offset">0ms</span><button id="btn-offset-up">▶</button></div>
                    </div>

                    <div class="opt-row" id="row-calib" style="justify-content: center;">
                        <button id="btn-calib-start" style="width:100%; background:#222; border:1px solid #444;">SYNC
                            MANAGER</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="scene-game" class="scene">
        <div id="bga-container">
            <video id="bga-video" src="" muted playsinline></video>
            <div id="bga-overlay"></div>
            <!-- [수정] 페이드 패널을 BGA 컨테이너 내부로 이동 (비디오만 가림) -->
            <div id="game-fade-panel" style="display:none;"></div>
        </div>
        <canvas id="game-canvas"></canvas>
        <!-- [신규] 일시정지 해제 카운트다운 -->
        <div id="countdown-timer"
            style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:120px; font-weight:bold; color:#00ffff; text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff; z-index:1000;">
            3</div>
    </section>

    <!-- [Live2D] 캐릭터 캔버스 - body 최상위 (모든 씬에서 사용) -->
    <canvas id="characterCanvas" style="position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:11; display:none;"></canvas>

    <section id="scene-result" class="scene">
        <!-- [신규] 배경 이미지 컨테이너 -->
        <div id="result-bg" class="result-bg"></div>

        <div class="result-container">
            <div class="result-left">
                <div class="rank-title">RANK</div>
                <div class="rank-large" id="res-rank">S</div>
                <div class="score-area">
                    <div class="label">TOTAL SCORE</div>
                    <div class="value" id="res-score">0</div>
                </div>

                <!-- [신규] 원형 차트 -->
                <div class="circular-chart-container">
                    <canvas id="circular-chart" width="220" height="220"></canvas>
                </div>

                <div class="stats-table">
                    <div class="row"><span class="l">PERFECT</span><span class="v p-color" id="res-perfect">0</span>
                    </div>
                    <div class="row"><span class="l">GREAT</span><span class="v gr-color" id="res-great"
                            style="color:#9ae6b4">0</span></div>
                    <div class="row"><span class="l">GOOD</span><span class="v g-color" id="res-good">0</span></div>
                    <div class="row"><span class="l">MISS</span><span class="v m-color" id="res-miss">0</span></div>
                    <div class="row"><span class="l">MAX COMBO</span><span class="v" id="res-combo">0</span></div>
                </div>
            </div>
            <div class="result-right">
                <div class="char-portrait" id="res-char-img">(Character)</div>
                <div class="dialog-box">
                    <div class="name">PARTNER / UNITY-CHAN</div>
                    <div class="text" id="res-msg">수고했어!</div>
                </div>
            </div>
        </div>
        <div class="result-nav"><span>[R] RETRY</span><span>[ENTER] MENU</span></div>
    </section>

    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div id="modal-exit-select" class="modal-box" style="display: none;">
            <h2>RETURN TO TITLE</h2>
            <p>메인 화면으로 돌아가시겠습니까?</p>
            <div class="btn-group"><button id="btn-exit-yes">YES</button><button id="btn-exit-no">NO</button></div>
        </div>
        <div id="modal-pause" class="modal-box" style="display: none;">
            <h2>PAUSED</h2>
            <div class="btn-group-vertical"><button id="btn-resume">RESUME</button><button id="btn-quit-game">EXIT
                    GAME</button></div>
        </div>
        <div id="cnt-overlay" class="countdown-box" style="display: none;">
            <div id="cnt-number">3</div>
        </div>

        <div id="modal-key-config" class="modal-box" style="display: none; width: 500px;">
            <h2>KEY CONFIG</h2>
            <p>키를 클릭하고 입력하세요.</p>
            <div class="key-config-grid" style="display:flex; justify-content:center; gap:20px; margin:30px 0;">
                <button class="key-btn" id="btn-key-0">D</button><button class="key-btn" id="btn-key-1">F</button>
                <button class="key-btn" id="btn-key-2">J</button><button class="key-btn" id="btn-key-3">K</button>
            </div>
            <div class="btn-group"><button id="btn-key-save">SAVE</button><button id="btn-key-cancel">CANCEL</button>
            </div>
        </div>

        <div id="modal-calibration" class="modal-box" style="display: none; width: 500px;">
            <h2>SYNC WIZARD</h2>
            <p>소리에 맞춰 키(D,F,J,K)를 누르세요.</p>
            <div id="calib-beat" class="beat-circle"></div>
            <div class="calib-info">
                <div>AVG ERROR: <span id="calib-avg" style="color:#00d2ff; font-weight:bold;">0ms</span></div>
            </div>
            <div class="btn-group" style="margin-top:20px;"><button id="btn-calib-apply">APPLY</button><button
                    id="btn-calib-cancel">CANCEL</button></div>
        </div>

        <!-- 에러/정보 모달 (새로 추가) -->
        <div id="modal-message" class="modal-box" style="display: none; width: 400px;">
            <h2 id="modal-message-title">알림</h2>
            <p id="modal-message-text" style="white-space: pre-line; line-height: 1.6;">메시지</p>
            <div class="btn-group" style="margin-top:20px;">
                <button id="btn-message-ok">확인</button>
            </div>
        </div>
    </div>

    <script type="module" src="./src/main.js"></script>
</body>

</html>